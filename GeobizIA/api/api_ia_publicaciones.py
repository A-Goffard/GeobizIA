from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
from typing import Optional
import os
from datetime import datetime

# Importaci√≥n opcional de OpenAI (solo si est√° instalado)
try:
    import openai
    OPENAI_AVAILABLE = True
except ImportError:
    OPENAI_AVAILABLE = False

from GeobizIA.controlador.gestores.actividades_realizadas import ActividadesRealizadas
from GeobizIA.controlador.gestores.actividades import Actividades

router = APIRouter()

class GenerarPublicacionRequest(BaseModel):
    id_actividad_realizada: int
    tipo_publicacion: str  # "anuncio", "durante", "completado"
    tono: str  # "profesional", "cercano", "motivacional"
    plataforma: str  # "instagram", "facebook", "twitter"
    incluir_hashtags: bool = True

class PublicacionGenerada(BaseModel):
    contenido: str
    hashtags: str
    caracteres: int
    plataforma: str

@router.post("/generar-publicacion")
def generar_publicacion_ia(request: GenerarPublicacionRequest) -> PublicacionGenerada:
    try:
        # Obtener datos de la actividad realizada
        gestor_realizadas = ActividadesRealizadas()
        gestor_actividades = Actividades()
        
        actividad_realizada = gestor_realizadas.buscar(request.id_actividad_realizada)
        if not actividad_realizada:
            raise HTTPException(status_code=404, detail="Actividad realizada no encontrada")
        
        actividad = gestor_actividades.buscar(actividad_realizada.id_actividad)
        if not actividad:
            raise HTTPException(status_code=404, detail="Actividad no encontrada")
        
        # Crear prompt personalizado
        prompt = crear_prompt_publicacion(actividad, actividad_realizada, request)
        
        # Generar con IA (usando plantillas mejoradas)
        contenido = generar_contenido_ia(prompt, request, actividad, actividad_realizada)
        
        # Generar hashtags
        hashtags = generar_hashtags(actividad, request) if request.incluir_hashtags else ""
        
        return PublicacionGenerada(
            contenido=contenido,
            hashtags=hashtags,
            caracteres=len(contenido + hashtags),
            plataforma=request.plataforma
        )
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Error al generar publicaci√≥n: {str(e)}")

def crear_prompt_publicacion(actividad, actividad_realizada, request):
    """Crea un prompt espec√≠fico para la generaci√≥n de contenido"""
    
    prompts_base = {
        "anuncio": f"""Crea una publicaci√≥n para anunciar la pr√≥xima actividad:
        Actividad: {actividad.nombre}
        Tipo: {actividad.tipo}
        Descripci√≥n: {actividad.descripcion or 'Actividad ambiental'}
        Duraci√≥n: {actividad.duracion}
        Responsable: {actividad.responsable}
        
        La publicaci√≥n debe ser para {request.plataforma} con tono {request.tono}.
        Debe generar expectaci√≥n y motivar a participar.""",
        
        "durante": f"""Crea una publicaci√≥n mientras se realiza la actividad:
        Actividad: {actividad.nombre}
        Fecha: {actividad_realizada.fecha}
        Asistentes: {actividad_realizada.asistentes or 'varios participantes'}
        
        La publicaci√≥n debe ser para {request.plataforma} con tono {request.tono}.
        Debe mostrar el evento en vivo y la participaci√≥n.""",
        
        "completado": f"""Crea una publicaci√≥n celebrando que la actividad se complet√≥:
        Actividad: {actividad.nombre}
        Fecha: {actividad_realizada.fecha}
        Asistentes: {actividad_realizada.asistentes or 'participantes'}
        Observaciones: {actividad_realizada.observaciones or 'Actividad exitosa'}
        
        La publicaci√≥n debe ser para {request.plataforma} con tono {request.tono}.
        Debe celebrar el √©xito y agradecer la participaci√≥n."""
    }
    
    return prompts_base.get(request.tipo_publicacion, prompts_base["completado"])

def generar_contenido_ia(prompt, request, actividad, actividad_realizada):
    """Genera el contenido usando IA o plantillas inteligentes mejoradas"""
    
    # CONFIGURACI√ìN: Cambiar a True para usar OpenAI (requiere API key)
    USAR_OPENAI = False
    
    # Opci√≥n 1: Intentar con OpenAI si est√° activado
    if USAR_OPENAI and OPENAI_AVAILABLE:
        contenido_openai = generar_con_openai_real(actividad, actividad_realizada, request)
        if contenido_openai:
            return contenido_openai
    
    # Opci√≥n 2: Usar plantillas inteligentes mejoradas (por defecto)
    
    # Extraer datos reales de la actividad
    nombre_actividad = actividad.nombre
    tipo_actividad = actividad.tipo or "actividad"
    descripcion = actividad.descripcion or ""
    responsable = actividad.responsable or "nuestro equipo"
    duracion = actividad.duracion or ""
    
    # Datos de la actividad realizada
    fecha = actividad_realizada.fecha if hasattr(actividad_realizada, 'fecha') else ""
    asistentes = actividad_realizada.asistentes if hasattr(actividad_realizada, 'asistentes') else ""
    observaciones = actividad_realizada.observaciones if hasattr(actividad_realizada, 'observaciones') else ""
    
    # Plantillas mejoradas por tipo de publicaci√≥n
    if request.tipo_publicacion == "anuncio":
        return generar_anuncio(nombre_actividad, tipo_actividad, descripcion, responsable, duracion, request)
    elif request.tipo_publicacion == "durante":
        return generar_durante(nombre_actividad, asistentes, observaciones, request)
    elif request.tipo_publicacion == "completado":
        return generar_completado(nombre_actividad, fecha, asistentes, observaciones, request)
    
    return "Contenido generado autom√°ticamente"

async def generar_con_openai_real(actividad, actividad_realizada, request):
    """Opci√≥n avanzada: usar OpenAI para contenido m√°s natural"""
    
    if not OPENAI_AVAILABLE:
        return None
    
    try:
        # Configurar OpenAI (necesitas tu API key)
        # openai.api_key = os.getenv("OPENAI_API_KEY")  # Descomenta esta l√≠nea
        
        # Crear prompt contextual detallado
        contexto = f"""
        Actividad: {actividad.nombre}
        Tipo: {actividad.tipo or 'actividad ambiental'}
        Descripci√≥n: {actividad.descripcion or 'Actividad enfocada en sostenibilidad'}
        Responsable: {actividad.responsable or 'nuestro equipo'}
        """
        
        if hasattr(actividad_realizada, 'fecha'):
            contexto += f"\nFecha: {actividad_realizada.fecha}"
        if hasattr(actividad_realizada, 'asistentes'):
            contexto += f"\nAsistentes: {actividad_realizada.asistentes}"
        
        prompt = f"""
        Eres un experto en marketing digital y comunicaci√≥n ambiental. 
        Crea una publicaci√≥n atractiva para {request.plataforma} con tono {request.tono}.
        
        Tipo de publicaci√≥n: {request.tipo_publicacion}
        
        Contexto de la actividad:
        {contexto}
        
        La publicaci√≥n debe:
        - Ser aut√©ntica y engaging
        - Usar emojis apropiados
        - Adaptarse al tono solicitado
        - Ser apropiada para {request.plataforma}
        - Motivar participaci√≥n o celebrar logros
        - Incluir llamadas a la acci√≥n cuando sea apropiado
        
        Genera solo el texto de la publicaci√≥n, sin hashtags.
        """
        
        # Aqu√≠ ir√≠as la llamada a OpenAI
        # response = openai.ChatCompletion.create(
        #     model="gpt-3.5-turbo",
        #     messages=[{"role": "user", "content": prompt}],
        #     max_tokens=300,
        #     temperature=0.7
        # )
        # return response.choices[0].message.content.strip()
        
        # Por ahora devuelve None para usar las plantillas mejoradas
        return None
        
    except Exception as e:
        print(f"Error con OpenAI: {e}")
        return None

# Funci√≥n para activar f√°cilmente OpenAI
def activar_openai():
    """
    Para activar OpenAI:
    1. Instala: pip install openai
    2. Configura tu API key en el archivo .env o como variable de entorno
    3. Descomenta las l√≠neas de c√≥digo de OpenAI en la funci√≥n generar_con_openai_real
    4. Cambia USAR_OPENAI a True en la funci√≥n generar_contenido_ia
    """
    pass

def generar_anuncio(nombre, tipo, descripcion, responsable, duracion, request):
    """Genera contenido para anunciar una actividad"""
    
    # Emojis contextuales
    emojis_tipo = {
        "taller": "üîß",
        "charla": "üí¨", 
        "limpieza": "üßπ",
        "plantacion": "üå±",
        "reciclaje": "‚ôªÔ∏è",
        "curso": "üìö",
        "evento": "üéâ",
        "conferencia": "üé§"
    }
    
    emoji = "üåç"  # Default
    for key, value in emojis_tipo.items():
        if key in tipo.lower():
            emoji = value
            break
    
    # Frases motivadoras contextuales
    frases_motivadoras = {
        "reciclaje": "Dale una segunda vida a los materiales",
        "plantacion": "Cada √°rbol cuenta para nuestro futuro",
        "limpieza": "Juntos por un entorno m√°s limpio",
        "energia": "El futuro es renovable",
        "agua": "Cuidemos nuestro recurso m√°s valioso"
    }
    
    frase_motivadora = "√önete al cambio que necesita nuestro planeta"
    for key, value in frases_motivadoras.items():
        if key in (tipo + descripcion).lower():
            frase_motivadora = value
            break
    
    # Plantillas por plataforma y tono
    plantillas = {
        "instagram": {
            "profesional": f"""{emoji} PR√ìXIMAMENTE: {nombre}

{frase_motivadora}

üìÖ Actividad: {tipo}
üë®‚Äçüè´ Con: {responsable}
‚è∞ Duraci√≥n: {duracion}

üìù Reserva tu plaza en el enlace de bio

#GeobizIA #Sostenibilidad""",
            
            "cercano": f"""¬°Hola eco-amigos! üëã

¬øListos para {nombre.lower()}? {emoji}

{frase_motivadora} üåü

Ser√° s√∫per interesante y lo pasaremos genial juntos. ¬°No te lo pierdas!

¬øTe apuntas? üíö""",
            
            "motivacional": f"""üö® ¬°ALERTA VERDE! üö®

{emoji} {nombre.upper()}

üí™ {frase_motivadora}
üî• Con {responsable}
‚ö° Solo {duracion}

¬°El planeta te NECESITA! üåç

#CambioClim√°tico #Act√∫aYa"""
        },
        
        "facebook": {
            "profesional": f"""Estimados amigos de GeobizIA,

Nos complace invitarles a {nombre}, una {tipo.lower()} que organizaremos pr√≥ximamente.

{frase_motivadora}. Esta iniciativa, dirigida por {responsable}, tendr√° una duraci√≥n de {duracion} y promete ser muy enriquecedora.

Los detalles completos los compartiremos pronto. ¬°Esperamos contar con su participaci√≥n!

#MedioAmbiente #GeobizIA""",
            
            "cercano": f"""¬°Hola queridos amigos! üòä

Queremos contarles sobre algo emocionante: ¬°{nombre}!

{frase_motivadora} y creemos que les va a encantar participar.

{responsable} ser√° quien nos acompa√±e en esta aventura verde. ¬øQui√©n se apunta?

¬°Comenten si est√°n interesados! üíö""",
            
            "motivacional": f"""üåç ¬°ATENCI√ìN TODOS! üåç

{nombre.upper()} est√° llegando y va a ser √âPICO.

{frase_motivadora} - ¬°Es AHORA o NUNCA!

Con {responsable} al frente, esta {tipo.lower()} va a cambiar tu perspectiva sobre el medio ambiente.

¬øEST√ÅS LISTO PARA EL DESAF√çO? üí™

#CambioClim√°tico #Acci√≥nAhora"""
        },
        
        "twitter": {
            "profesional": f"""{emoji} Pr√≥ximamente: {nombre}

{frase_motivadora}

üë®‚Äçüè´ {responsable}
‚è∞ {duracion}

#Sostenibilidad #GeobizIA""",
            
            "cercano": f"""¬°Hey! üëã 

{nombre} est√° por llegar {emoji}

{frase_motivadora} ¬øTe unes? üíö

#EcoLife #GeobizIA""",
            
            "motivacional": f"""üö® {nombre.upper()} üö®

{frase_motivadora}

¬°El planeta te NECESITA! üåçüí™

#Act√∫aYa #CambioClim√°tico"""
        }
    }
    
    return plantillas[request.plataforma][request.tono]

def generar_durante(nombre, asistentes, observaciones, request):
    """Genera contenido mientras se realiza la actividad"""
    
    asistentes_texto = f"{asistentes} personas incre√≠bles" if asistentes else "un grupo fant√°stico"
    
    plantillas = {
        "instagram": {
            "profesional": f"""üî¥ EN VIVO: {nombre}

Actualmente desarrollando esta importante actividad con {asistentes_texto}.

üìä Progreso excelente
üë• Participaci√≥n activa  
üéØ Objetivos en camino

#EnVivo #Sostenibilidad #GeobizIA""",
            
            "cercano": f"""¬°Estamos en plena acci√≥n! üí™

{nombre} est√° siendo incre√≠ble con {asistentes_texto} üî•

La energ√≠a es contagiosa y todos est√°n s√∫per motivados. ¬°Os seguimos contando!

Stories m√°s tarde üì∏""",
            
            "motivacional": f"""üî• ¬°ESTO EST√Å PASANDO AHORA! üî•

{nombre.upper()} en plena acci√≥n con {asistentes_texto}

‚ö° Energ√≠a AL M√ÅXIMO
üéØ Objetivos CUMPLIDOS
üí™ Poder del equipo IMPARABLE

#LiveAction #CambioReal"""
        },
        
        "facebook": {
            "profesional": f"""üìç Actualizaci√≥n en tiempo real

{nombre} se est√° desarrollando exitosamente con la participaci√≥n de {asistentes_texto}.

La respuesta ha sido excelente y estamos cumpliendo todos los objetivos planificados. Seguiremos informando sobre los avances.

#GeobizIA #MedioAmbiente""",
            
            "cercano": f"""¬°Hola desde {nombre}! üëã

Estamos aqu√≠ con {asistentes_texto} pas√°ndolo genial y aprendiendo un mont√≥n üòä

El ambiente es s√∫per bueno y todos est√°n muy participativos. ¬°Esto es lo que necesit√°bamos!

¬°Ya os contaremos todo! üíö""",
            
            "motivacional": f"""üö® ¬°ESTO EST√Å OCURRIENDO AHORA MISMO! üö®

{nombre} en PLENA ACCI√ìN con {asistentes_texto}

La ENERG√çA es INCRE√çBLE. Esto es lo que pasa cuando las personas se unen por el planeta üåç

¬°EL CAMBIO ES REAL Y EST√Å PASANDO! üí™

#ChangeIsNow #PlanetAction"""
        },
        
        "twitter": {
            "profesional": f"""üî¥ {nombre} en curso

{asistentes_texto} participando activamente

Excelente desarrollo üëç

#EnVivo #Sostenibilidad""",
            
            "cercano": f"""¬°En plena acci√≥n! üí™

{nombre} con {asistentes_texto} üî•

¬°La energ√≠a es incre√≠ble! üíö

#EcoAction""",
            
            "motivacional": f"""üî• ¬°AHORA MISMO! üî•

{nombre.upper()}

{asistentes_texto} CAMBIANDO EL MUNDO üåçüí™

#ActuaYa"""
        }
    }
    
    return plantillas[request.plataforma][request.tono]

def generar_completado(nombre, fecha, asistentes, observaciones, request):
    """Genera contenido celebrando actividad completada"""
    
    asistentes_texto = f"{asistentes} participantes" if asistentes else "nuestros participantes"
    logros = observaciones if observaciones else "resultados excelentes"
    
    plantillas = {
        "instagram": {
            "profesional": f"""‚úÖ COMPLETADO: {nombre}

¬°Actividad finalizada con gran √©xito!

üéØ Participaron {asistentes_texto}
üìà {logros}
üåü Objetivos superados

Gracias a todos por hacer posible este cambio positivo.

#Completado #√âxito #GeobizIA #Sostenibilidad""",
            
            "cercano": f"""¬°Y eso es todo amigos! üéâ

{nombre} ha terminado y ha sido INCRE√çBLE üíö

{asistentes_texto} maravillosos que han hecho que todo sea especial ‚ú®

{logros} y muchas sonrisas despu√©s... ¬°MISI√ìN CUMPLIDA!

¬°Gracias por la buena energ√≠a! ü§ó""",
            
            "motivacional": f"""üèÜ ¬°MISI√ìN CUMPLIDA! üèÜ

{nombre.upper()} = ¬°√âXITO TOTAL!

üéâ {asistentes_texto} INCRE√çBLES
üíØ {logros}  
üöÄ ¬°Ya pensando en la SIGUIENTE!

¬°ESTO ES LO QUE PASA CUANDO NOS UNIMOS! üí™üåç

#Misi√≥nCumplida #CambioReal #Imparables"""
        },
        
        "facebook": {
            "profesional": f"""‚úÖ {nombre} - Actividad completada exitosamente

Nos complace informar que la actividad se ha desarrollado de manera excelente, contando con la participaci√≥n de {asistentes_texto}.

Destacamos: {logros}

Agradecemos profundamente a todos los participantes por su compromiso y entusiasmo. Iniciativas como esta nos demuestran que juntos podemos lograr un impacto positivo real.

¬°Hasta la pr√≥xima actividad!

#GeobizIA #MedioAmbiente #Comunidad""",
            
            "cercano": f"""¬°Qu√© d√≠a m√°s especial hemos tenido! üòä

{nombre} se ha completado y estamos s√∫per contentos con los resultados. {asistentes_texto} fant√°sticos han participado y la verdad es que hemos conseguido {logros.lower()}.

Es genial ver c√≥mo cuando nos juntamos por una buena causa, las cosas salen incre√≠bles üíö

¬°Muchas gracias a todos! Ya estamos pensando en la pr√≥xima üòâ""",
            
            "motivacional": f"""üéä ¬°BOMBAZO DE ACTIVIDAD COMPLETADA! üéä

{nombre.upper()} ha sido un √âXITO ROTUNDO

üëè {asistentes_texto} VALIENTES que dijeron S√ç al cambio
üî• {logros}
üí™ Demostrado: ¬°JUNTOS SOMOS IMPARABLES!

Esto NO termina aqu√≠. ¬°El planeta nos necesita y NOSOTROS RESPONDEMOS!

¬øQUI√âN SE APUNTA A LA SIGUIENTE REVOLUCI√ìN VERDE? üåç

#RevolucionVerde #JuntosSomosImparables"""
        },
        
        "twitter": {
            "profesional": f"""‚úÖ {nombre} completado

{asistentes_texto} participaron
{logros}

¬°Gracias por el compromiso! üíö

#Sostenibilidad #GeobizIA""",
            
            "cercano": f"""¬°Ya est√°! üéâ

{nombre} completado con {asistentes_texto} geniales üíö

{logros} ¬°Gracias equipo! ü§ó

#EcoTeam""",
            
            "motivacional": f"""üèÜ ¬°COMPLETADO! üèÜ

{nombre.upper()}

{asistentes_texto} CAMBIANDO EL MUNDO üåç

¬°IMPARABLES! üí™üî•

#CambioReal"""
        }
    }
    
    return plantillas[request.plataforma][request.tono]

def generar_hashtags(actividad, request):
    """Genera hashtags relevantes e inteligentes"""
    hashtags_base = ["#GeobizIA"]
    
    # Hashtags por tipo de actividad (an√°lisis inteligente)
    nombre_lower = actividad.nombre.lower()
    tipo_lower = (actividad.tipo or "").lower()
    descripcion_lower = (actividad.descripcion or "").lower()
    
    todo_texto = f"{nombre_lower} {tipo_lower} {descripcion_lower}"
    
    # Categor√≠as tem√°ticas
    if any(palabra in todo_texto for palabra in ["reciclaje", "recicl", "residuo", "basura"]):
        hashtags_base.extend(["#Reciclaje", "#EconomiaCircular", "#ZeroWaste"])
    
    if any(palabra in todo_texto for palabra in ["planta", "√°rbol", "reforest", "siembra", "verde"]):
        hashtags_base.extend(["#Reforestacion", "#PlantarArboles", "#VidaVerde"])
    
    if any(palabra in todo_texto for palabra in ["limpieza", "limpiar", "basura", "residuo"]):
        hashtags_base.extend(["#LimpiezaAmbiental", "#CuidemosElPlaneta"])
    
    if any(palabra in todo_texto for palabra in ["energia", "solar", "eolica", "renovable"]):
        hashtags_base.extend(["#EnergiaRenovable", "#EnergiaLimpia", "#Sustentabilidad"])
    
    if any(palabra in todo_texto for palabra in ["agua", "hidrico", "mar", "rio", "oc√©ano"]):
        hashtags_base.extend(["#CuidarElAgua", "#RecursoHidrico", "#AguaLimpia"])
    
    if any(palabra in todo_texto for palabra in ["taller", "workshop", "curso", "formacion"]):
        hashtags_base.extend(["#Educacion", "#TallerAmbiental", "#Formacion"])
    
    if any(palabra in todo_texto for palabra in ["conferencia", "charla", "seminario"]):
        hashtags_base.extend(["#ConcienciaAmbiental", "#EducacionAmbiental"])
    
    # Hashtags tem√°ticos generales
    hashtags_base.extend(["#MedioAmbiente", "#Sostenibilidad"])
    
    # Hashtags por tipo de publicaci√≥n
    if request.tipo_publicacion == "anuncio":
        hashtags_base.extend(["#Proximamente", "#Apuntate", "#NoTeLoPierdas"])
    elif request.tipo_publicacion == "durante":
        hashtags_base.extend(["#EnVivo", "#Ahora", "#LiveAction"])
    elif request.tipo_publicacion == "completado":
        hashtags_base.extend(["#Completado", "#Exito", "#MisionCumplida"])
    
    # Hashtags espec√≠ficos por plataforma
    if request.plataforma == "instagram":
        hashtags_base.extend(["#EcoFriendly", "#GreenLife", "#NaturalezaLovers", "#EcoWarrior"])
    elif request.plataforma == "twitter":
        hashtags_base.extend(["#ClimateAction", "#EcoTech", "#GreenTech"])
    elif request.plataforma == "facebook":
        hashtags_base.extend(["#ComunidadVerde", "#JuntosPorelPlaneta"])
    
    # Hashtags por tono
    if request.tono == "motivacional":
        hashtags_base.extend(["#CambioClim√°tico", "#AccionAhora", "#Imparables"])
    elif request.tono == "cercano":
        hashtags_base.extend(["#EcoAmigos", "#VidaVerde", "#NaturalezaAmica"])
    elif request.tono == "profesional":
        hashtags_base.extend(["#ResponsabilidadSocial", "#DesarrolloSostenible"])
    
    # Eliminar duplicados y limitar cantidad
    hashtags_unicos = list(dict.fromkeys(hashtags_base))  # Preserva orden y elimina duplicados
    
    # Diferentes l√≠mites por plataforma
    limite = {
        "instagram": 10,  # Instagram permite hasta 30, pero 10 es m√°s efectivo
        "twitter": 5,     # Twitter es m√°s limitado en caracteres
        "facebook": 8     # Facebook prefiere menos hashtags
    }.get(request.plataforma, 8)
    
    return " ".join(hashtags_unicos[:limite])

@router.get("/actividades-realizadas")
def listar_actividades_para_ia():
    """Obtiene las actividades realizadas para el selector"""
    try:
        gestor_realizadas = ActividadesRealizadas()
        gestor_actividades = Actividades()
        
        realizadas = gestor_realizadas.mostrar_todos_los_elem()
        resultado = []
        
        for realizada in realizadas:
            actividad = gestor_actividades.buscar(realizada.id_actividad)
            if actividad:
                resultado.append({
                    "id_actividad_realizada": realizada.id_actividad_realizada,
                    "nombre_actividad": actividad.nombre,
                    "fecha": realizada.fecha,
                    "asistentes": realizada.asistentes,
                    "tipo": actividad.tipo
                })
        
        return resultado
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Error al obtener actividades: {str(e)}")
